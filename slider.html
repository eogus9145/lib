<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .test {
            width: 100%;
            height: 100px;
            border: 1px solid #000;
        }
    </style>
    <script>
        class Slider {
            constructor(cssSelector, option) {

                if(cssSelector.startsWith(".")) {
                    this.targetType = "class";
                } else if(cssSelector.startsWith("#")) {
                    this.targetType = "id";
                } else {
                    return;
                }
                this.cssSelector = cssSelector;
                this.option = option;

                // option
                this.direction = (this.option && this.option.direction) ? this.option.direction : 'horizontal';
                this.speed = this.option && this.option.speed ? this.option.speed : 1;
                this.deg = (this.option && this.option.deg) ? this.option.deg : 0;
                this.gap = (this.option && this.option.gap) ? this.option.gap : 0;
                this.margin = (this.option.margin && this.option.margin) ? this.option.margin : 0;
                this.padding = (this.option && this.option.padding) ? this.option.padding : 0;
                this.reverse = this.option && this.option.reverse ? this.option.reverse : false;
                this.cross = (this.targetType == 'class' && this.option && this.option.cross) ? this.option.cross : false;
                this.fill = (this.option && this.option.fill == false) ? false : true;
                this.hoverStop = (this.option && this.option.hoverStop) ? this.option.hoverStop : false;

                this.init();

            }

            async init() {
                document.addEventListener("DOMContentLoaded", async (e) => {
                    if(this.targetType == 'id') {
                        let target = document.querySelector(this.cssSelector);
                        this.targetWidth = target.offsetWidth;
                        this.targetHeight = target.offsetHeight;
                        let slide = target.querySelector(".slide");
                        let items = slide.querySelectorAll(".slide-item");
                        let lastImg = items[items.length - 1].querySelector("img");
                        new Promise((resolve) => {
                            lastImg.onload = async () => {
                                this['position0'] = 0;
                                await this.resize(target, slide, 0, items);
                                let cnt = await this.cloning(slide, items);
                                await this.sliding(slide, 0, cnt);
                                await this.setEvent(target, slide, 0, cnt);
                                resolve();
                            };
                        });
                    } else if(this.targetType == 'class') {
                        let targets = document.querySelectorAll(this.cssSelector);
                        for(let i=0; i<targets.length; i++) {
                            let target = targets[i];
                            let idx = i;
                            this.targetWidth = target.offsetWidth;
                            this.targetHeight = target.offsetHeight;
                            if(idx > 0) target.style.marginLeft = this.margin + "px";
                            let slide = target.querySelector(".slide");
                            let items = slide.querySelectorAll(".slide-item");
                            let lastImg = items[items.length - 1].querySelector("img");
                            new Promise((resolve) => {
                                lastImg.onload = async () => {
                                    this['position'+idx] = 0;
                                    await this.resize(target, slide, idx, items);
                                    let cnt = await this.cloning(slide, items);
                                    await this.sliding(slide, idx, cnt);
                                    await this.setEvent(target, slide, idx, cnt);
                                    resolve();
                                };
                            });
                        }
                    }
                });
            }

            async setEvent(target, slide, idx, cnt) {
                if(this.hoverStop) {
                    target.addEventListener("mouseenter", async (e) => {
                        cancelAnimationFrame(this['animationFrameId' + idx]);
                    });
                    target.addEventListener("mouseleave", async (e) => {
                        this.sliding(slide, idx, cnt);
                    });
                }
            }

            async resize(target, slide, idx, items) {
                target.style.overflow = "hidden";
                target.style.position = "relative";
                target.style.backgroundColor = "#fff";
                slide.style.display = "flex";
                slide.style.position = "absolute";
                slide.style.gap = this.gap + "px";
                slide.style.willChange = "transform";
                let imgDirection = "";
                if(this.direction == 'horizontal') {
                    slide.style.height = "100%";
                    if(this.reverse) {
                        if(this.cross && idx % 2 !== 0) {
                            slide.style.left = 0;    
                        } else {
                            slide.style.right = 0;
                        }
                    } else {
                        if(this.cross && idx % 2 !== 0) {
                            slide.style.right = 0;
                        } else {
                            slide.style.left = 0;
                        }
                    }
                    imgDirection = "height";
                } else if(this.direction == 'vertical') {
                    slide.style.width = "100%";
                    slide.style.flexDirection = "column";
                    if(this.reverse) {
                        if(this.cross && idx % 2 !== 0) {
                            slide.style.top = 0;
                        } else {
                            slide.style.bottom = 0;
                        }
                    } else {
                        if(this.cross && idx % 2 !== 0) {
                            slide.style.bottom = 0;
                        } else {
                            slide.style.top = 0;
                        }
                    }
                    imgDirection = "width";
                }
                for(let i=0; i<items.length; i++) {
                    let item = items[i];
                    item.style.padding = this.padding + "px";
                    let img = item.querySelector("img");
                    img.style[imgDirection] = "100%";
                }
                if(this.deg != 0) {
                    target.style.transform = `rotate(${this.deg}deg)`
                }
            }

            async cloning(slide, items) {
                let totalWidth = 0;
                let totalHeight = 0;
                for(let i=0; i<items.length; i++) {
                    let item = items[i];
                    totalHeight += item.offsetHeight;
                    totalWidth += item.offsetWidth;
                }
                let divCnt = 1;
                if(this.fill) {
                    if(this.direction == 'horizontal') {
                        divCnt = Math.ceil(this.targetWidth / totalWidth);
                    } else if(this.direction == 'vertical') {
                        divCnt = Math.ceil(this.targetHeight / totalHeight);
                    }
                    if(divCnt < 2) divCnt = 2;
                    for(let j=0; j<divCnt; j++) {
                        for(let i=0; i<items.length; i++) {
                            let item = items[i];
                            let clone = item.cloneNode(true);
                            slide.appendChild(clone);
                        }
                    }
                }

                return divCnt;
            }

            async sliding(slide, idx, divCnt) {
                console.log(divCnt);
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                }
                divCnt = divCnt + 1;
                const animate = () => {
                    if(this.reverse) {
                        if(this.cross && idx % 2 !== 0) {
                            this['position' + idx] -= this.speed;
                        } else {
                            this['position' + idx] += this.speed;
                        }
                        if(this.direction == 'horizontal') {
                            if(this.cross && idx % 2 !== 0) {
                                let limit = -(slide.scrollWidth / divCnt);
                                if (this['position' + idx] < limit) {
                                    this['position' + idx] = divCnt == 1 ? (this.targetWidth) : 0;
                                }
                            } else {
                                let limit = (slide.scrollWidth / divCnt);
                                if (this['position' + idx] >= limit) {
                                    this['position' + idx] = divCnt == 1 ? -(this.targetWidth) : 0;
                                }                                
                            }
                            slide.style.transform = `translateX(${this['position' + idx]}px)`;
                        } else if(this.direction == 'vertical') {
                            if(this.cross && idx % 2 !== 0) {
                                let limit = -(slide.scrollHeight / divCnt);
                                if (this['position' + idx] < limit) {
                                    this['position' + idx] = divCnt == 1 ? (this.targetHeight) : 0;
                                }
                            } else {
                                let limit = (slide.scrollHeight / divCnt);
                                if (this['position' + idx] >= limit) {
                                    this['position' + idx] = divCnt == 1 ? -(this.targetHeight) : 0;
                                }                                
                            }
                            slide.style.transform = `translateY(${this['position' + idx]}px)`;
                        }
                    } else {
                        if(this.cross && idx % 2 !== 0) {
                            this['position' + idx] += this.speed;
                        } else {
                            this['position' + idx] -= this.speed;
                        }
                        if(this.direction == 'horizontal') {
                            if(this.cross && idx % 2 !== 0) {
                                let limit = (slide.scrollWidth / divCnt);
                                if (this['position' + idx] >= limit) {
                                    this['position' + idx] = divCnt == 1 ? -(this.targetWidth) : 0;
                                }
                            } else {
                                let limit = -(slide.scrollWidth / divCnt);
                                if (this['position' + idx] < limit) {
                                    this['position' + idx] = divCnt == 1 ? this.targetWidth : 0;
                                }
                            }
                            slide.style.transform = `translateX(${this['position' + idx]}px)`;
                        } else if(this.direction == 'vertical') {
                            if(this.cross && idx % 2 !== 0) {
                                let limit = (slide.offsetHeight / divCnt);
                                if (this['position' + idx] >= limit) {
                                    this['position' + idx] = divCnt == 1 ? -(this.targetHeight) : 0;
                                }
                            } else {
                                let limit = -(slide.scrollHeight / divCnt);
                                if (this['position' + idx] < limit) {
                                    this['position' + idx] = divCnt == 1 ? this.targetHeight : 0;
                                }                                
                            }
                            slide.style.transform = `translateY(${this['position' + idx]}px)`;
                        }  
                    }
                    this['animationFrameId' + idx] = requestAnimationFrame(animate);
                }
                this['animationFrameId' + idx] = requestAnimationFrame(animate);
            }
        }
        
    </script>
</head>
<body>

    <div class="test">
        <div class="slide">
            <div class="slide-item">
                <img src="./sample1.png">
            </div>
            <div class="slide-item">
                <img src="./sample2.jpg">
            </div>
            <div class="slide-item">
                <img src="./sample3.gif">
            </div>
        </div>
    </div>

    <div class="test">
        <div class="slide">
            <div class="slide-item">
                <img src="./sample1.png">
            </div>
            <div class="slide-item">
                <img src="./sample2.jpg">
            </div>
            <div class="slide-item">
                <img src="./sample3.gif">
            </div>
        </div>
    </div>

    <script>
        let slider = new Slider(
            ".test", 
            {
                direction: 'horizontal', 
                speed: 1, 
                deg: 0, 
                gap: 0, 
                margin : 0, 
                padding: 10,
                fill: true,
                cross : true,
                hoverStop: true,
            }
        );
    </script>
</body>
</html>
